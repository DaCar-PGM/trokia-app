import streamlit as st
import google.generativeai as genai
from PIL import Image
import re
import requests
from bs4 import BeautifulSoup
from duckduckgo_search import DDGS
import statistics
import random

# --- CONFIGURATION ---
st.set_page_config(page_title="Trokia v19.3 : Prix Vendus Uniquement", page_icon="‚öñÔ∏è", layout="wide")

# --- LISTE DES MOD√àLES IA SOUHAIT√âS ---
MODELS_PRIORITY = [
    "models/gemini-2.5-pro", "models/gemini-2.0-flash", "models/gemini-2.0-flash-001",
    "models/gemini-2.0-flash-lite", "models/gemini-exp-1206", "models/gemini-pro-latest"
]

# --- 1. MOTEUR IA FURTIF (TRAVAILLE EN ARRI√àRE-PLAN) ---
def obtenir_meilleur_cerveau():
    genai.configure(api_key=st.secrets["GEMINI_API_KEY"])
    try:
        available = [m.name for m in genai.list_models() if 'generateContent' in m.supported_generation_methods]
        for target in MODELS_PRIORITY:
            if target in available: return target
        return "models/gemini-1.5-flash"
    except: return "models/gemini-1.5-flash"

def analyser_objet_furtif(images_pil):
    """Analyse l'objet via les mod√®les IA en arri√®re-plan"""
    try:
        model = genai.GenerativeModel(obtenir_meilleur_cerveau())
        prompt = (
            "Analyse ces photos pour identifier l'objet (V√™tement, Meuble, Jeu, etc.). "
            "D√©termine marque, mod√®le exact et mat√©riaux. "
            "Propose les 5 mod√®les ou variantes les plus probables pour confirmation.\n"
            "Format STRICT :\n1. Nom Mod√®le 1\n2. Nom Mod√®le 2\n3. Nom Mod√®le 3\n4. Nom Mod√®le 4\n5. Nom Mod√®le 5"
        )
        response = model.generate_content([prompt] + images_pil)
        lines = response.text.strip().split('\n')
        return [re.sub(r'^\d+\.\s*', '', l).strip() for l in lines if l and l[0].isdigit()][:5]
    except: return ["Analyse indisponible"]

def get_ref_image(query):
    try:
        with DDGS() as ddgs:
            results = list(ddgs.images(keywords=query, region="fr-fr", max_results=1))
            return results[0]['image'] if results else "https://via.placeholder.com/150"
    except: return "https://via.placeholder.com/150"

# --- 2. MOTEUR DE PRIX : PARAM√àTRE "VENDUS UNIQUEMENT" ---
def extraire_cote_vendus_uniquement(nom):
    """Calcule la cote en utilisant exclusivement les transactions termin√©es"""
    prices = []
    headers = {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"}
    
    try:
        # Param√®tres eBay : LH_Sold=1 (Vendu) et LH_Complete=1 (Termin√©)
        # C'est ce param√®tre qui garantit que l'on ne regarde pas les annonces en cours.
        clean_q = nom.replace(' ', '+')
        url = f"https://www.ebay.fr/sch/i.html?_nkw={clean_q}&LH_Sold=1&LH_Complete=1"
        
        r = requests.get(url, headers=headers, timeout=10)
        soup = BeautifulSoup(r.text, 'html.parser')
        
        # On extrait les prix des objets r√©ellement vendus
        for tag in soup.select('.s-item__price'):
            p_raw = tag.get_text().replace('\xa0', '').replace(' ', '').replace('EUR', '').replace('‚Ç¨', '')
            match = re.search(r'(\d+[\.,]?\d*)', p_raw)
            if match:
                val = float(match.group(1).replace(',', '.'))
                # Filtre de s√©curit√© pour √©viter les accessoires ou erreurs de saisie
                if 2 < val < 25000: prices.append(val)
    except: pass
    
    # On utilise la m√©diane pour obtenir le prix de vente le plus repr√©sentatif
    cote = statistics.median(prices) if prices else 0
    fiabilite = "Haute (Transactions r√©elles)" if len(prices) > 8 else "Moyenne"
    return cote, fiabilite

# --- 3. INTERFACE ---
if 'step' not in st.session_state: st.session_state.step = "input"

st.sidebar.title("üíé Trokia Pro")
if st.sidebar.button("üîÑ Remise √† z√©ro compl√®te"):
    for key in list(st.session_state.keys()): del st.session_state[key]
    st.session_state.step = "input"
    st.rerun()

st.title("‚öñÔ∏è L'Argus Universel (Prix Vendus)")

if st.session_state.step == "input":
    st.write("### 1. Analyse de l'objet")
    files = st.file_uploader("Ins√©rez jusqu'√† 5 photos pour expertise", type=['jpg','png','jpeg'], accept_multiple_files=True)
    
    st.divider()
    q_man = st.text_input("Ou saisissez manuellement le mod√®le (Ex: iPhone 12)")
    
    if st.button("Lancer l'Analyse üöÄ", type="primary"):
        if files:
            with st.spinner("Analyse multi-mod√®les en cours..."):
                imgs = [Image.open(f) for f in files[:5]]
                st.session_state.props = analyser_objet_furtif(imgs)
                st.session_state.imgs_ref = [get_ref_image(p) for p in st.session_state.props]
                st.session_state.step = "selection"
                st.rerun()
        elif q_man:
            st.session_state.nom_final = q_man
            st.session_state.step = "resultat"
            st.rerun()

elif st.session_state.step == "selection":
    st.write("### 2. Confirmez votre mod√®le")
    cols = st.columns(5)
    for i, col in enumerate(cols):
        if i < len(st.session_state.props):
            with col:
                st.image(st.session_state.imgs_ref[i], use_container_width=True)
                if st.button(f"C'est celui-ci :\n{st.session_state.props[i]}", key=f"btn_{i}"):
                    st.session_state.nom_final = st.session_state.props[i]
                    st.session_state.step = "resultat"
                    st.rerun()

elif st.session_state.step == "resultat":
    nom = st.session_state.nom_final
    with st.spinner(f"Calcul de la cote (ventes termin√©es uniquement) pour {nom}..."):
        cote, fiab = extraire_cote_vendus_uniquement(nom)
        img_fin = get_ref_image(nom)
    
    c1, c2 = st.columns([1, 2])
    with c1: st.image(img_fin, use_container_width=True)
    with c2:
        st.header(nom)
        if cote > 0:
            st.metric("PRIX DE VENTE R√âEL", f"{cote:.2f} ‚Ç¨")
            st.success(f"Cette cote est bas√©e exclusivement sur des transactions finalis√©es ({fiab}).")
        else:
            st.warning("Aucune transaction vendue trouv√©e pour ce mod√®le pr√©cis.")
        
        if st.button("üîô Nouvelle expertise"):
            st.session_state.step = "input"
            st.rerun()
