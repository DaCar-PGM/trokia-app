import streamlit as st
import google.generativeai as genai
from PIL import Image
import re
import requests
from bs4 import BeautifulSoup
from duckduckgo_search import DDGS
import statistics
import random

# --- CONFIGURATION ---
st.set_page_config(page_title="Trokia v19.2 : Multi-IA", page_icon="‚öñÔ∏è", layout="wide")

# --- LISTE DES MOD√àLES SOUHAIT√âS (ORDRE DE PRIORIT√â) ---
MODELS_PRIORITY = [
    "models/gemini-2.5-pro", "models/gemini-3-pro-preview", "models/gemini-2.0-flash",
    "models/gemini-exp-1206", "models/gemini-1.5-pro", "models/gemini-1.5-flash"
]

# --- MOTEUR IA FURTIF (ARRI√àRE-PLAN) ---
def obtenir_meilleur_cerveau():
    genai.configure(api_key=st.secrets["GEMINI_API_KEY"])
    available = [m.name for m in genai.list_models() if 'generateContent' in m.supported_generation_methods]
    # On cherche le premier mod√®le de TA liste qui est disponible sur TA cl√©
    for target in MODELS_PRIORITY:
        if target in available: return target
    return "models/gemini-1.5-flash" # Secours ultime

def analyser_objet_furtif(images_pil):
    try:
        model_name = obtenir_meilleur_cerveau()
        model = genai.GenerativeModel(model_name)
        
        prompt = (
            "Analyse ces images pour un vendeur ou acheteur. Identifie l'objet pr√©cis√©ment "
            "(V√™tement, Meuble, Jeu, √âlectronique, etc.). D√©termine la marque, le mod√®le exact et les mat√©riaux. "
            "Propose les 5 variantes ou mod√®les les plus probables pour que l'utilisateur confirme.\n"
            "Format STRICT :\n1. Nom Mod√®le 1\n2. Nom Mod√®le 2\n3. Nom Mod√®le 3\n4. Nom Mod√®le 4\n5. Nom Mod√®le 5"
        )
        
        response = model.generate_content([prompt] + images_pil)
        lines = response.text.strip().split('\n')
        return [re.sub(r'^\d+\.\s*', '', l).strip() for l in lines if l and l[0].isdigit()][:5]
    except Exception as e:
        return [f"Erreur Analyse: {str(e)[:20]}"]

def get_ref_image(query):
    try:
        with DDGS() as ddgs:
            results = list(ddgs.images(keywords=query, region="fr-fr", max_results=1))
            return results[0]['image'] if results else "https://via.placeholder.com/150"
    except: return "https://via.placeholder.com/150"

# --- MOTEUR DE PRIX (ANTI-0‚Ç¨) ---
def extraire_cote_reelle(nom):
    prices = []
    headers = {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"}
    try:
        url = f"https://www.ebay.fr/sch/i.html?_nkw={nom.replace(' ', '+')}&LH_Sold=1&LH_Complete=1"
        r = requests.get(url, headers=headers, timeout=10)
        soup = BeautifulSoup(r.text, 'html.parser')
        for tag in soup.select('.s-item__price'):
            p_raw = tag.get_text().replace('\xa0', '').replace(' ', '').replace('EUR', '').replace('‚Ç¨', '')
            match = re.search(r'(\d+[\.,]?\d*)', p_raw)
            if match:
                val = float(match.group(1).replace(',', '.'))
                if 2 < val < 20000: prices.append(val)
    except: pass
    return (statistics.median(prices) if prices else 0), ("√âlev√©e" if len(prices) > 8 else "Moyenne")

# --- INTERFACE ---
if 'step' not in st.session_state: st.session_state.step = "input"

st.sidebar.title("üíé Trokia Pro")
if st.sidebar.button("üîÑ Remise √† z√©ro compl√®te"):
    for key in list(st.session_state.keys()): del st.session_state[key]
    st.session_state.step = "input"
    st.rerun()

st.title("‚öñÔ∏è L'Argus Universel")

if st.session_state.step == "input":
    st.write("### 1. Analyse de l'objet (Vente ou Achat)")
    files = st.file_uploader("Ins√©rez jusqu'√† 5 photos pour une expertise multi-mod√®les", type=['jpg','png','jpeg'], accept_multiple_files=True)
    
    st.divider()
    q_man = st.text_input("Ou saisissez manuellement le mod√®le ou l'EAN")
    
    if st.button("Lancer l'Analyse üöÄ", type="primary"):
        if files:
            with st.spinner("Les mod√®les IA analysent votre objet en arri√®re-plan..."):
                imgs = [Image.open(f) for f in files[:5]]
                st.session_state.props = analyser_objet_furtif(imgs)
                st.session_state.imgs_ref = [get_ref_image(p) for p in st.session_state.props]
                st.session_state.step = "selection"
                st.rerun()
        elif q_man:
            st.session_state.nom_final = q_man
            st.session_state.step = "resultat"
            st.rerun()

elif st.session_state.step == "selection":
    st.write("### 2. Est-ce l'un de ces 5 mod√®les ?")
    st.caption("L'IA a identifi√© ces variantes. Cliquez sur la photo exacte pour valider l'Argus.")
    
    cols = st.columns(5) # Passage √† 5 colonnes
    for i, col in enumerate(cols):
        if i < len(st.session_state.props):
            with col:
                st.image(st.session_state.imgs_ref[i], use_container_width=True)
                if st.button(f"S√©lectionner :\n{st.session_state.props[i]}", key=f"btn_{i}"):
                    st.session_state.nom_final = st.session_state.props[i]
                    st.session_state.step = "resultat"
                    st.rerun()

elif st.session_state.step == "resultat":
    nom = st.session_state.nom_final
    with st.spinner(f"Calcul de la valeur pour {nom}..."):
        cote, fiab = extraire_cote_reelle(nom)
        img_fin = get_ref_image(nom)
    
    c1, c2 = st.columns([1, 2])
    with c1: st.image(img_fin, use_container_width=True)
    with c2:
        st.header(nom)
        if cote > 0:
            st.metric("VALEUR ESTIM√âE", f"{cote:.2f} ‚Ç¨")
            st.info(f"Indice de fiabilit√© du march√© : {fiab}")
        else:
            st.warning("Prix non trouv√©. Essayez une recherche plus large.")
        
        if st.button("üîô Nouvelle expertise"):
            st.session_state.step = "input"
            st.rerun()
